<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8">
        <title>ƒê·∫∑t H√†ng ‚Äì B∆° Milk Tea</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" href="css/order.css">
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    </head>
    <body>

    <h1>üçπ ƒê·∫∑t Tr√† S·ªØa Ngay!</h1>

    <div class="search-box">
        <input id="searchInput" type="text" placeholder="üîç T√¨m m√≥n theo t√™n...">

        <button class="undo-btn" onclick="undo()">Undo</button>
    </div>

    

    <table>
        <thead>
            <tr>
                <th>
                    M√≥n
                    <span class="sort-btn" onclick="sortNameAsc()">‚ñ≤</span>
                    <span class="sort-btn" onclick="sortNameDesc()">‚ñº</span>
                </th>
                <th>
                    Gi√°
                    <span class="sort-btn" onclick="sortPriceAsc()">‚ñ≤</span>
                    <span class="sort-btn" onclick="sortPriceDesc()">‚ñº</span>
                </th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>T·ªïng</th>
            </tr>
        </thead>
        <tbody id="menuBody"></tbody>
    </table>

    <div class="summary-box">
        <h3>H√≥a ƒê∆°n</h3>
        <div class="total-line"><span>T·ªïng:</span><span id="grandTotal">0K</span></div>
        <div class="total-line"><span>Gi·∫£m:</span><span id="discount">0K</span></div>
        <div class="total-line"><span>Ship:</span><span id="delivery">0K</span></div>
        <hr>
        <div class="total-line highlight">
            <span>Thanh to√°n:</span><span id="finalPrice">0K</span>
        </div>

        <button class="order-btn" onclick="showOrderSuccess()">ƒê·∫∑t h√†ng ngay!!!</button>
    </div>

    <!-- DATA + ALGO -->
    <script src="js/data.js"></script>
    <script src="js/algo.js"></script>

    <script>
        /* ======================
        INIT DSA STRUCTURES
        ====================== */
        const undoStack = new Stack();
        const redoStack = new Stack();
        const cart = new CartLinkedList();

        /* ======================
        FLATTEN MENU DATA
        ====================== */
        let flatMenu = [];
        menuData.forEach(group => {
            group.items.forEach(item => {
                flatMenu.push({
                    name: item.name,
                    price: item.price,
                    category: group.category
                });
            });
        });

        /* ======================
        RENDER MENU
        ====================== */
        const tbody = document.getElementById("menuBody");

        function renderMenu(data) {
            tbody.innerHTML = "";
            let lastCategory = "";

            data.forEach(item => {
                if (item.category !== lastCategory) {
                    tbody.innerHTML += `
                        <tr>
                            <td colspan="4" class="category-row">${item.category}</td>
                        </tr>`;
                    lastCategory = item.category;
                }

                tbody.innerHTML += `
                    <tr data-name="${item.name}" data-price="${item.price}">
                        <td>${item.name}</td>
                        <td>${Math.round(item.price / 1000)}K</td>
                        <td>
                            <div class="qty-box">
                                <button class="qty-btn" onclick="changeQty(this,-1)">-</button>
                                <input type="number" class="order-input" value="0" min="0">
                                <button class="qty-btn" onclick="changeQty(this,1)">+</button>
                            </div>
                        </td>
                        <td class="total-cell">0K</td>
                    </tr>`;
            });
        }

        renderMenu(flatMenu);

        /* ======================
        FORMAT
        ====================== */
        function formatK(v) {
            return Math.round(v / 1000) + "K";
        }

        /* ======================
        SAVE STATE ‚Äì STACK
        ====================== */
        function saveState() {
            const state = [...document.querySelectorAll(".order-input")].map(i => i.value);
            undoStack.push(state);
            redoStack.clear();
        }

        /* ======================
        CHANGE QTY
        ====================== */
        function changeQty(btn, delta) {
            saveState();

            const row = btn.closest("tr");
            const input = row.querySelector(".order-input");

            let val = Math.max(0, (+input.value || 0) + delta);
            input.value = val;

            const name = row.dataset.name;
            const price = +row.dataset.price;

            if (val > 0) {
                cart.addOrUpdate({ name, price, qty: val });
            } else {
                cart.remove(name);
            }

            row.querySelector(".total-cell").textContent = formatK(val * price);
            updateTotals();
        }

        /* ======================
        UPDATE TOTALS ‚Äì LINKED LIST
        ====================== */
        function updateTotals() {
            const total = cart.getTotal();

            grandTotal.textContent = formatK(total);
            discount.textContent = total >= 100000 ? "10K" : "0K";
            delivery.textContent = total > 0 ? "5K" : "0K";
            finalPrice.textContent = formatK(
                total - (total >= 100000 ? 10000 : 0) + (total > 0 ? 5000 : 0)
            );
        }

        function rebuildCartFromUI() {
            cart.head = null;

            document.querySelectorAll("#menuBody tr[data-price]").forEach(row => {
                const qty = parseInt(row.querySelector(".order-input").value);
                if (qty > 0) {
                    cart.addOrUpdate({
                        name: row.dataset.name,
                        price: parseInt(row.dataset.price),
                        qty
                    });
                }
            });
        }

        //in undo
        function undo() {
            if (undoStack.isEmpty()) return;

            // Save current state for redo
            const current = [...document.querySelectorAll(".order-input")].map(i => i.value);
            redoStack.push(current);

            // Pop previous state
            const prev = undoStack.pop();

            // Restore input values
            document.querySelectorAll(".order-input").forEach((input, i) => input.value = prev[i]);

            // Rebuild cart linked list
            rebuildCartFromUI();

            // Update per-row totals
            document.querySelectorAll("#menuBody tr[data-price]").forEach(row => {
                const qty = parseInt(row.querySelector(".order-input").value);
                const price = parseInt(row.dataset.price);
                row.querySelector(".total-cell").textContent = formatK(qty * price);
            });

            // Update bottom totals
            updateTotals();
        }

        /* ======================
        SEARCH ‚Äì KMP
        ====================== */
        const searchInput = document.getElementById("searchInput");

        searchInput.addEventListener("input", function () {
            const keyword = this.value.trim().toLowerCase();
            if (!keyword) return renderMenu(flatMenu);

            // Use the true KMP search
            const results = KMPSearchCart(flatMenu, keyword);
            renderMenu(results);
        });


        /* ======================
        SORT CONTROLS
        ====================== */
        function sortNameAsc() {
            renderMenu(quickSortByName(flatMenu, true));
        }
        function sortNameDesc() {
            renderMenu(quickSortByName(flatMenu, false));
        }
        function sortPriceAsc() {
            renderMenu(bubbleSortByPrice(flatMenu, true));
        }
        function sortPriceDesc() {
            renderMenu(bubbleSortByPrice(flatMenu, false));
        }

        /* ======================
        ORDER SUCCESS
        ====================== */
        
    function showOrderSuccess() {

        // ===== REAL-TIME CALCULATION =====
        const total = cart.getTotal();
        const discountVal = total >= 100000 ? 10000 : 0;
        const deliveryVal = total > 0 ? 5000 : 0;
        const finalVal = total - discountVal + deliveryVal;

        // ===== FORMAT TIME =====
        const now = new Date();
        const timeStr = now.toLocaleTimeString("vi-VN");
        const dateStr = now.toLocaleDateString("vi-VN");

        Swal.fire({
            title: "üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng!",
            html: `
                üïí <b>Th·ªùi gian:</b> ${timeStr} ‚Äì ${dateStr}<br><br>

                <b>T·ªïng:</b> ${formatK(total)}<br>
                <b>Gi·∫£m gi√°:</b> ${formatK(discountVal)}<br>
                <b>Ph√≠ ship:</b> ${formatK(deliveryVal)}<br>
                <hr>
                <b style="font-size:18px;color:#2b8f47">
                    Thanh to√°n: ${formatK(finalVal)}
                </b><br><br>

                C·∫£m ∆°n b·∫°n ƒë√£ ·ªßng h·ªô <b>B∆° Milk Tea</b> ‚ù§Ô∏è
            `,
            icon: "success",
            confirmButtonColor: "#2b8f47",
            confirmButtonText: "OK"
        }).then(() => {
            location.href = "index.html";
        });
    }
    </script>

    </body>
</html>
